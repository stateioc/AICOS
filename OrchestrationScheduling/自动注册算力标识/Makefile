.PHONY: build run clean

GO := go
DOCKER := docker
PROJ_ROOT_DIR := $(CURDIR)
TAG := $(shell date +"%Y%m%d%H%M%S")
CONTAINER_REGISTRY := wenxinlee
PROJ_NAME_PREFIX := register-power-resources

BINARY_CONTROLLER := controller
CMD_DIR_CONTROLLER := ./cmd/$(BINARY_CONTROLLER)
INSTALL_DIR_CONTROLLER := ./install/$(BINARY_CONTROLLER)

BINARY_SERVER := server
CMD_DIR_SERVER := ./cmd/$(BINARY_SERVER)
INSTALL_DIR_SERVER := ./install/$(BINARY_SERVER)

BINARY_CLIENT := client
CMD_DIR_CLIENT := ./cmd/$(BINARY_CLIENT)
INSTALL_DIR_CLIENT := ./install/${BINARY_SERVER}/$(BINARY_CLIENT)

BINARY_REPORTER := node-reporter
CMD_DIR_REPORTER := ./cmd/$(BINARY_REPORTER)
INSTALL_DIR_REPORTER := ./install/$(BINARY_REPORTER)

build:
	@echo "Building..."
	@$(GO) build -o $(INSTALL_DIR_CONTROLLER)/$(BINARY_CONTROLLER) $(CMD_DIR_CONTROLLER)
	@$(GO) build -o $(INSTALL_DIR_SERVER)/$(BINARY_SERVER) $(CMD_DIR_SERVER)
	@$(GO) build -o $(INSTALL_DIR_SERVER)/client/$(BINARY_CLIENT) $(CMD_DIR_CLIENT)
	@$(GO) build -o $(INSTALL_DIR_REPORTER)/$(BINARY_REPORTER) $(CMD_DIR_REPORTER)
	@echo "Build complete"

docker: build
	@cd $(PROJ_ROOT_DIR) && cd $(INSTALL_DIR_CONTROLLER) && $(DOCKER) build -t $(CONTAINER_REGISTRY)/$(PROJ_NAME_PREFIX)-$(BINARY_CONTROLLER):$(TAG) .
	@cd $(PROJ_ROOT_DIR) && cd $(INSTALL_DIR_SERVER) && $(DOCKER) build -t $(CONTAINER_REGISTRY)/$(PROJ_NAME_PREFIX)-$(BINARY_SERVER):$(TAG) .
	@cd $(PROJ_ROOT_DIR) && cd $(INSTALL_DIR_REPORTER) && $(DOCKER) build -t $(CONTAINER_REGISTRY)/$(PROJ_NAME_PREFIX)-$(BINARY_REPORTER):$(TAG) .

push: docker
	@$(DOCKER) push $(CONTAINER_REGISTRY)/$(PROJ_NAME_PREFIX)-$(BINARY_CONTROLLER):$(TAG)
	@$(DOCKER) push $(CONTAINER_REGISTRY)/$(PROJ_NAME_PREFIX)-$(BINARY_SERVER):$(TAG)
	@$(DOCKER) push $(CONTAINER_REGISTRY)/$(PROJ_NAME_PREFIX)-$(BINARY_REPORTER):$(TAG)

run: build
	@echo "Running server..."
	@$(INSTALL_DIR_CONTROLLER)/$(BINARY_CONTROLLER) &
	@$(INSTALL_DIR_SERVER)/$(BINARY_SERVER) &
	@$(INSTALL_DIR_REPORTER)/$(BINARY_REPORTER) &

clean:
	@echo "Cleaning up..."
	@rm -f $(INSTALL_DIR_CONTROLLER)/$(BINARY_CONTROLLER) $(INSTALL_DIR_SERVER)/$(BINARY_SERVER) $(INSTALL_DIR_CLIENT)/$(BINARY_CLIENT) $(INSTALL_DIR_REPORTER)/$(BINARY_REPORTER)
	@echo "Clean complete"